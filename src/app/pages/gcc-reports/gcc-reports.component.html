<app-report-container>
  <app-page-header [title]="'العاملين في دول مجلس التعاون'"></app-page-header>

  <app-card>
    <app-alert
      [show]="
        messageService.isVisible() && messageService.messageType() === 'success'
      "
      [type]="'success'"
      [message]="messageService.messageText()"
    ></app-alert>

    <app-alert
      [show]="
        messageService.isVisible() && messageService.messageType() === 'error'
      "
      [type]="'error'"
      [message]="messageService.messageText()"
    ></app-alert>

    <div class="p-6">
      <form [formGroup]="reportForm" (ngSubmit)="generateReport()">
        <!-- Report Type Selection -->
        <app-form-field
          [label]="'نوع التقرير'"
          [required]="true"
          [containerClass]="'mb-6'"
          [showError]="hasError('reportType')"
          [errorMessage]="getError('reportType')"
        >
          <select formControlName="reportType" class="form-select-rtl">
            <option value="">اختر نوع التقرير</option>
            <optgroup label="تقارير أصحاب الأعمال">
              @for (report of getReportsByCategory('employer'); track report.id;
              let i = $index) {
              <option [value]="report.id">
                {{ i + 1 }}. {{ report.nameAr }}
              </option>
              }
            </optgroup>
            <optgroup label="تقارير الموظفين">
              @for (report of getReportsByCategory('employee'); track report.id;
              let i = $index) {
              <option [value]="report.id">
                {{ i + 1 + getReportsByCategory("employer").length }}.
                {{ report.nameAr }}
              </option>
              }
            </optgroup>
            <optgroup label="التقارير المالية">
              @for (report of getReportsByCategory('financial'); track
              report.id; let i = $index) {
              <option [value]="report.id">
                {{
                  i +
                    1 +
                    getReportsByCategory("employer").length +
                    getReportsByCategory("employee").length
                }}. {{ report.nameAr }}
              </option>
              }
            </optgroup>
            <optgroup label="تقارير خاصة">
              @for (report of getReportsByCategory('special'); track report.id;
              let i = $index) {
              <option [value]="report.id">
                {{
                  i +
                    1 +
                    getReportsByCategory("employer").length +
                    getReportsByCategory("employee").length +
                    getReportsByCategory("financial").length
                }}. {{ report.nameAr }}
              </option>
              }
            </optgroup>
          </select>
        </app-form-field>

        <!-- Dynamic Fields -->
        @if (selectedReportType) {
        <div class="space-y-4">
          <!-- Date Field -->
          @if (selectedReportType !== 'GCCRPT150' && selectedReportType !==
          'GCCRPTPF7') {
          <div class="form-grid">
            <app-form-field
              [label]="'التاريخ'"
              [required]="isFieldRequired('date')"
              [showError]="hasError('date')"
              [errorMessage]="getError('date')"
            >
              <input
                type="date"
                formControlName="date"
                class="form-input-rtl"
              />
            </app-form-field>
          </div>
          }

          <!-- Start/Stop Dates -->
          @if (selectedReportType === 'GCCRPT150' || selectedReportType ===
          'GCCRPTPF7') {
          <div class="form-grid">
            <app-form-field
              [label]="'تاريخ البداية'"
              [required]="isFieldRequired('startDate')"
              [showError]="hasError('startDate')"
              [errorMessage]="getError('startDate')"
            >
              <input
                type="date"
                formControlName="startDate"
                class="form-input-rtl"
              />
            </app-form-field>
            <app-form-field
              [label]="'تاريخ النهاية'"
              [required]="isFieldRequired('stopDate')"
              [showError]="hasError('stopDate')"
              [errorMessage]="getError('stopDate')"
            >
              <input
                type="date"
                formControlName="stopDate"
                class="form-input-rtl"
              />
            </app-form-field>
          </div>
          @if (reportForm.hasError('dateRange')) {
          <p class="form-error">
            {{ getError("dateRange") }}
          </p>
          } }

          <!-- Registration Number -->
          @if (selectedReportType === 'GCCRPTPF7') {
          <div class="form-grid">
            <app-form-field
              [label]="'رقم التسجيل'"
              [required]="true"
              [hint]="'يجب أن يكون 7 أرقام'"
              [showError]="hasError('regNum')"
              [errorMessage]="getError('regNum')"
            >
              <input
                type="text"
                formControlName="regNum"
                class="form-input-rtl"
                maxlength="7"
              />
            </app-form-field>
          </div>
          }

          <!-- Balance -->
          @if (selectedReportType === 'GCCRPT130') {
          <div class="form-grid">
            <app-form-field
              [label]="'الحد الأدنى للرصيد'"
              [required]="true"
              [showError]="hasError('balance')"
              [errorMessage]="getError('balance')"
            >
              <input
                type="number"
                formControlName="balance"
                class="form-input-rtl"
                min="0"
              />
            </app-form-field>
          </div>
          }

          <!-- Country Code -->
          @if (selectedReportType === 'GCCRPT130' || selectedReportType ===
          'GCCRPTPF1') {
          <div class="form-grid">
            <app-form-field
              [label]="'الدولة'"
              [required]="true"
              [showError]="hasError('countryCode')"
              [errorMessage]="getError('countryCode')"
            >
              <select formControlName="countryCode" class="form-select-rtl">
                <option value="">اختر الدولة</option>
                @for (country of gccCountries; track country.code; let i =
                $index) {
                <option [value]="country.code">
                  {{ i + 1 }}. {{ country.nameAr }}
                </option>
                }
              </select>
            </app-form-field>
          </div>
          }

          <!-- Amount Type -->
          @if (selectedReportType === 'CMYGC009') {
          <div class="form-grid">
            <app-form-field
              [label]="'نوع الدفع'"
              [required]="true"
              [showError]="hasError('amountKD')"
              [errorMessage]="getError('amountKD')"
            >
              <select formControlName="amountKD" class="form-select-rtl">
                <option value="">اختر نوع الدفع</option>
                @for (type of amountTypes; track type.value; let i = $index) {
                <option [value]="type.value">
                  {{ i + 1 }}. {{ type.labelAr }}
                </option>
                }
              </select>
            </app-form-field>
          </div>
          }
        </div>
        }

        <app-button
          [loading]="loading"
          [disabled]="reportForm.invalid"
          [text]="'إنشاء التقرير'"
          (btnClick)="generateReport()"
        ></app-button>
      </form>
    </div>
  </app-card>
</app-report-container>
